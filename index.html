<!DOCTYPE html>
<html>
<title>Thomas Ville experiments</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
body,h1,h2,h3,h4,h5,h6 {font-family: "Lato", sans-serif;}
a{text-decoration: none}
body, html {
    height: 100%;
    color: #777;
    line-height: 1.8;
    overflow: hidden;
}
canvas {
    position: fixed;
    z-index: 1;
}
#name {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    position: fixed;
    z-index: 2;
    transition: opacity 2s linear;
    opacity: 0;
    letter-spacing: 10px;
}

#name.visible {
    opacity: 0.9;
}
.icons {
    margin: auto 0 auto 20px;
}

.credits-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    position: absolute;
    right: 10px;
    bottom: 10px;
}
.credits {
    margin: auto;
}
.w3-hover-opacity {cursor: pointer;}

</style>
<noscript>
    <!-- Display the text directly when JS is not allowed-->
    <style>
    #name {
        opacity: 1;
    }
    </style>
</noscript>
<body>
<div id="dpi" style="height: 1in; width: 1in; left: 100%; position: fixed; top: 100%;"></div>
<div class="w3-display-container w3-opacity-min" id="home">
    <div class="w3-center w3-padding-large w3-black w3-display-middle w3-xlarge w3-wide" id="name">
        THOMAS VILLE
        <div class="icons">
            <a href="https://github.com/WhiteMoll" class="fa fa-github w3-hover-opacity icon"></a>
            <a href="https://twitter.com/VilleThomas" class="fa fa-twitter w3-hover-opacity icon"></a>
            <a href="https://www.linkedin.com/in/thomas-ville-832107a7/" class="fa fa-linkedin w3-hover-opacity"></a>
        </div>
    </div>
</div>


<div class="credits-container">
    <button id="toggle-animation-btn" onclick="onToggleAnimationClick(this)" class="w3-button w3-light-grey">Animation On</button>
    <button onclick="onTweakClick()" class="w3-button w3-light-grey">Tweak</button>
    <span class="credits">Thomas Ville - Made with p5.js, p5gui and w3.css</span>
</div>
<script src="./p5/p5.min.js"></script>
<script src="https://cdn.rawgit.com/bit101/quicksettings/master/quicksettings.js"></script>
<script src="https://cdn.rawgit.com/bitcraftlab/p5.gui/master/libraries/p5.gui.js"></script>
<script>
    var myCanvas = undefined;
    // Variables
    // Number of particles
    var nbParticles = 100;
    var nbParticlesMin = 0;
    var nbParticlesMax = 1000;
    var particles = [];

    var lineR = 0;
    var lineRMax = 255;
    var lineG = 0;
    var lineGMax = 255;
    var lineB = 0;
    var lineBMax = 255;

    var backgroundR = 255;
    var backgroundRMax = 255;
    var backgroundG = 255;
    var backgroundGMax = 255;
    var backgroundB = 255;
    var backgroundBMax = 255;

    var dayColorPalette = [0, 0, 0, 255, 255, 255];
    var nightColorPalette = [255, 255, 255, 0, 0, 0];

    var play = true;
    
    adaptColorPaletteToHourOfDay();
    

    var minClientSize = document.body.clientWidth < document.body.clientHeight ? document.body.clientWidth : document.body.clientHeight;
    var maxDistance = Math.floor(minClientSize/4);
    var maxDistanceMin = 1;
    var maxDistanceMax = minClientSize;

    let width = document.body.clientWidth;
    let height = document.body.clientHeight;

    const origWidth = width;
    const origHeight = height;

    var gui;
    var isGuiVisible = false;
    var consecutiveFPSDrops = 0, consecutiveFPSAbove = 0;
    
    document.getElementById('name').classList.add('visible');

    function setup() {
        // Rescales to 1080p when the screen is qHD (for smartphones)
        // Sorry for people who have UHD screens ^^
        if(width * height > 3500000)
            pixelDensity(0.75);

        // Create the canvas
        myCanvas = createCanvas(width, height);
        myCanvas.parent('home');
        frameRate(60);

        // Set the tweaking gui
        gui = createGui('Particle playground');
        gui.addGlobals('lineColor', 'maxDistance', 'play', 'lineR', 'lineG', 'lineB', 'backgroundR', 'backgroundG', 'backgroundB');
        gui.hide();
        
        // Add some particles
        for(let i = 0; i < nbParticles; i++) {
            addParticle(particles);
        }
    }

    function draw() {
        if(!play) return;
        if(frameRate() > 20) {
            background('rgb('+backgroundR+','+backgroundG+','+backgroundB+')');

            for(let i = 0; i < particles.length; i++) {
                if(particles[i].position.x > width + maxDistance || particles[i].position.x < -maxDistance || particles[i].position.y > height + maxDistance || particles[i].position.y < -maxDistance) {
                    respawnParticle(particles[i]);
                } else {
                    particles[i].position.x += particles[i].direction.x/frameRate();
                    particles[i].position.y += particles[i].direction.y/frameRate();
                }
                stroke('rgb('+lineR+','+lineG+','+lineB+')');
                
                let distance = Math.sqrt(Math.pow(particles[i].position.x - mouseX, 2) + Math.pow(particles[i].position.y - mouseY, 2));
                if(distance < maxDistance) {
                    strokeWeight(2 - distance/(maxDistance/2));
                    line(mouseX, mouseY, particles[i].position.x, particles[i].position.y);
                }
                for(let j = i+1; j < particles.length; j++) {
                    let distance = particles[i].position.dist(particles[j].position);
                    if(distance < maxDistance) {
                        strokeWeight(1 - distance/(maxDistance/1));
                        line(particles[i].position.x, particles[i].position.y, particles[j].position.x, particles[j].position.y);
                    }
                }
            }
        } else {
            consecutiveFPSDrops++;
            if(consecutiveFPSDrops > 20) {
                // Second stage of optimization : stop the animation
                document.getElementById('toggle-animation-btn').click();
            } else if(consecutiveFPSDrops > 10) {
                // First stage of optimization : scale down the rendering definition
                pixelDensity(0.75);
            }
        }
    }
    function mouseDragged(t) {
        if(t.target == myCanvas.canvas) {
            addParticle(particles, mouseX, mouseY);
            return false;
        }
    }
    // dynamically adjust the canvas to the window
    function windowResized() {
        width = windowWidth;
        height = windowHeight;
        minClientSize = width < height ? width : height;
        
        resizeCanvas(windowWidth, windowHeight);
    }

    /******* Particles ********/
    function addParticle(particles, x, y) {
        x = x || Math.random()*width;
        y = y || Math.random()*height;

        let direction = createVector(Math.random()-0.5, Math.random()-0.5);
        direction.setMag(Math.random()*20+10);

        particles.push({
            position: createVector(x,y),
            direction: direction
        });
    }
    function respawnParticle(particle) {
        let randX = 0;
        let randY = 0;
        let allowedTries = 10;
        do {
            randX = Math.random()*width;
            randY = Math.random()*height;
            allowedTries--;
        } while(allowedTries !== 0 && isConnectedToParticles(particles, maxDistance, randX, randY));
        particle.position.x = randX;
        particle.position.y = randY;
    }
    function isConnectedToParticles(particles, maxDistance, x, y) {
        let invisible = true;
        let position = createVector(x, y);
        for(let j = 0; j < particles.length; j++) {
            if(particles[j].position.dist(position) < maxDistance) {
                invisible = false;
                break;
            }
        }
        return !invisible;
    }

    /******* Utilities ********/
    function distance(x1, y1, x2, y2) {
        return Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2));
    }
    function setColors(colorPalette) {
        lineR = colorPalette[0];
        lineG = colorPalette[1];
        lineB = colorPalette[2];

        backgroundR = colorPalette[3];
        backgroundG = colorPalette[4];
        backgroundB = colorPalette[5];
    }
    function adaptColorPaletteToHourOfDay() {
        var curHr = new Date().getHours();

        if (18 <= curHr|| curHr < 8) {
            setColors(nightColorPalette);
        } else {
            setColors(dayColorPalette);
        }
    }
    
    function onTweakClick() {
        isGuiVisible = !isGuiVisible;
        if(isGuiVisible) {
            gui.show();
            document.getElementById('name').classList.remove('visible');
        } else {
            gui.hide();
            document.getElementById('name').classList.add('visible');
        }
    }
    function onToggleAnimationClick(el) {
        play = !play;
        if(play) {
            el.innerHTML = 'Animation On';
        } else {
            el.innerHTML = 'Animation Off';            
        }
    }
</script>

</body>
</html>
